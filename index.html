<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Organization Chart</title>
    
    <!-- Tailwind CSS for sleek, modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- D3.js and D3 Org Chart Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-org-chart@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-flextree@2.1.2/build/d3-flextree.js"></script>
    
    <!-- PapaParse for parsing the CSV file in the browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .node-card { transition: box-shadow 0.2s, border-color 0.2s, transform 0.2s; }
        .node-card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-screen overflow-hidden font-sans selection:bg-blue-200">

    <div id="chart-container" class="w-full h-full cursor-grab active:cursor-grabbing"></div>

    <!-- Top Left: Controls & Search -->
    <div class="absolute top-4 left-4 w-80 flex flex-col gap-3 z-10">
        <div class="bg-white/90 backdrop-blur shadow-lg border border-slate-200 rounded-xl p-5">
            <h1 class="text-lg font-bold text-slate-900 flex items-center gap-2 mb-1">
                <i data-lucide="network" class="w-5 h-5 text-blue-600"></i>
                Org Explorer
            </h1>
            <div id="employee-count" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mb-3">0 Employees loaded</div>
            <p class="text-xs text-slate-500 mb-4">Upload your PeopleSoft CSV to map the hierarchy.</p>
            
            <label class="flex items-center justify-center w-full px-4 py-2 bg-slate-100 hover:bg-slate-200 text-sm font-medium text-slate-700 rounded-lg cursor-pointer transition-colors border border-slate-300 border-dashed">
                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>
                Upload CSV
                <input type="file" id="csvFileInput" accept=".csv" class="hidden" />
            </label>
            <div id="file-status" class="text-xs text-green-600 mt-2 hidden font-medium text-center">Data loaded successfully!</div>
        </div>

        <div class="bg-white/90 backdrop-blur shadow-lg border border-slate-200 rounded-xl p-2 relative">
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                <input type="text" id="searchInput" placeholder="Search people or teams..." 
                    class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" />
            </div>
            <div id="searchResults" class="absolute top-full left-0 w-full mt-2 bg-white border border-slate-200 shadow-xl rounded-xl overflow-hidden max-h-60 overflow-y-auto hidden">
                <!-- Results injected here -->
            </div>
        </div>
        
        <!-- Semantic Depth Toggles -->
        <div class="flex gap-2">
            <button onclick="expandSemantic('ADM')" class="flex-1 bg-white shadow border border-slate-200 rounded-lg py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition" title="Show Executives">Level 1 (ADMs)</button>
            <button onclick="expandSemantic('Band')" class="flex-1 bg-white shadow border border-slate-200 rounded-lg py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition" title="Show Management">Level 2 (Bands)</button>
            <button onclick="expandSemantic('All')" class="flex-1 bg-white shadow border border-slate-200 rounded-lg py-1.5 text-xs font-semibold text-slate-600 hover:bg-slate-50 transition" title="Show Everyone">All Staff</button>
        </div>
    </div>

    <!-- Right Side: Employee Profile Panel -->
    <div id="profilePanel" class="absolute top-4 right-4 w-80 bg-white shadow-2xl border border-slate-200 rounded-xl flex flex-col z-10 transition-transform duration-300 translate-x-[120%] opacity-0 h-[calc(100vh-2rem)]">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Employee Profile</h2>
            <button onclick="closeProfile()" class="p-1 hover:bg-slate-200 rounded-md text-slate-400 hover:text-slate-700 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div class="p-6 flex flex-col items-center border-b border-slate-100">
            <div id="profileAvatar" class="w-20 h-20 rounded-full bg-blue-100 border-4 border-white shadow-sm flex items-center justify-center text-2xl font-bold text-blue-600 mb-3"></div>
            <h3 id="profileName" class="text-xl font-bold text-slate-900 text-center"></h3>
            <p id="profileTitle" class="text-sm text-blue-600 font-medium text-center mt-1"></p>
            <span id="profileBranch" class="mt-3 px-3 py-1 bg-slate-100 text-slate-600 text-xs font-semibold rounded-full border border-slate-200"></span>
        </div>

        <div class="p-6 flex-1 overflow-y-auto">
            <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Position Details</h4>
            <div class="space-y-4">
                <div>
                    <p class="text-xs text-slate-500 mb-1">Position ID</p>
                    <p id="profilePosId" class="text-sm font-medium text-slate-800"></p>
                </div>
                <div>
                    <p class="text-xs text-slate-500 mb-1">Department</p>
                    <p id="profileDept" class="text-sm font-medium text-slate-800"></p>
                </div>
                <div>
                    <p class="text-xs text-slate-500 mb-1">Classification</p>
                    <p id="profileClass" class="text-sm font-medium text-slate-800"></p>
                </div>
                <div>
                    <p class="text-xs text-slate-500 mb-1">Reports To</p>
                    <p id="profileSupervisor" class="text-sm font-medium text-slate-800"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Right: Zoom Controls -->
    <div class="absolute bottom-6 right-6 bg-white shadow-lg border border-slate-200 rounded-lg flex flex-col z-10 overflow-hidden">
        <button onclick="chart.zoomIn()" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors border-b border-slate-100" title="Zoom In">
            <i data-lucide="zoom-in" class="w-5 h-5"></i>
        </button>
        <button onclick="chart.zoomOut()" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors border-b border-slate-100" title="Zoom Out">
            <i data-lucide="zoom-out" class="w-5 h-5"></i>
        </button>
        <button onclick="chart.fit()" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors border-b border-slate-100" title="Fit to Screen">
            <i data-lucide="maximize" class="w-5 h-5"></i>
        </button>
        <button onclick="expandSemantic('All')" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors border-b border-slate-100" title="Expand All (Warning: Large)">
            <i data-lucide="unfold-vertical" class="w-5 h-5"></i>
        </button>
        <button onclick="chart.collapseAll().fit()" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors border-b border-slate-100" title="Collapse All">
            <i data-lucide="fold-vertical" class="w-5 h-5"></i>
        </button>
        <button onclick="toggleLayout()" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors border-b border-slate-100" title="Toggle Layout (Vertical/Horizontal)">
            <i data-lucide="arrow-right-left" class="w-5 h-5"></i>
        </button>
        <button onclick="chart.exportImg({full: true})" class="p-3 text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-colors" title="Export as Image">
            <i data-lucide="download" class="w-5 h-5"></i>
        </button>
    </div>

    <script>
        lucide.createIcons();

        let chart;
        let globalData = [];
        
        // Expanded Default Data
        const defaultCSV = `Branch,Name,Classification,Position ID,Department,Job Title,Supervisor Position ID,Supervisor Name
Executive,Julien Santos,ADM,70717355,000-0000,Associate Deputy Minister,,
Executive,Diana Prince,Band 3,80000001,000-0000,Chief of Staff,70717355,Julien Santos
Digital Services,Rohan Rahman,ADM,72498494,000-0000,Assistant Deputy Minister,70717355,Julien Santos
Corporate Services,Liam McIntyre,ADM,35488219,000-0000,Assistant Deputy Minister,70717355,Julien Santos
Infrastructure & Ops,Marcus Usman,ADM,73855860,000-0000,Assistant Deputy Minister,70717355,Julien Santos
Data & Analytics,Rohan Kowalski,ADM,22633036,000-0000,Assistant Deputy Minister,70717355,Julien Santos
People & Culture,Mei McIntyre,ADM,22169593,000-0000,Assistant Deputy Minister,70717355,Julien Santos
Corporate Services,Miguel Petrov,Band 5,89918134,669-2580,Executive Director,35488219,Liam McIntyre
Digital Services,Fatima Rahman,Band 5,12013364,064-0975,Executive Director,72498494,Rohan Rahman
Data & Analytics,Navdeep Ivanov,Band 5,35529320,200-8505,Executive Director,22633036,Rohan Kowalski
Digital Services,Amrit Lopez,IS 21,73416496,749-2145,Senior Analyst,12013364,Fatima Rahman
People & Culture,Navdeep Xu,FO 18,37113369,200-8505,Policy Analyst,22169593,Mei McIntyre
Infrastructure & Ops,Amrit Kaur,Band 3,97256857,476-7976,Senior Analyst,73855860,Marcus Usman
People & Culture,Fatima Lopez,IS 24,66419615,235-8403,Service Designer,22169593,Mei McIntyre
Cybersecurity,Ben Zhao,AO 15,65723278,614-0492,Senior Analyst,73855860,Marcus Usman
Infrastructure & Ops,Julien Kowalski,Band 2,36369108,200-8505,System Admin,73855860,Marcus Usman
Digital Services,Clark Kent,Band 5,80000003,064-0975,Director UX,72498494,Rohan Rahman
Digital Services,Barry Allen,Band 5,80000004,064-0975,Director Engineering,72498494,Rohan Rahman
Digital Services,Wally West,IS 27,80000010,749-2145,Lead Developer,80000004,Barry Allen
Digital Services,Kyle Rayner,IS 24,80000011,749-2145,Full Stack Dev,80000010,Wally West
Corporate Services,Oliver Queen,Band 5,80000014,669-2580,Director Finance,35488219,Liam McIntyre
Infrastructure & Ops,Lex Luthor,Band 5,80000024,476-7976,Director Systems,73855860,Marcus Usman
Cybersecurity,Jimmy Olsen,Band 5,80000026,614-0492,CISO,73855860,Marcus Usman
Data & Analytics,Harvey Dent,Band 5,80000035,200-8505,Director Data Science,22633036,Rohan Kowalski
People & Culture,Lucius Fox,Band 5,80000047,200-8505,Director HR,22169593,Mei McIntyre`;

        // Utility algorithm to assign organizational ranking weight for sorting
        function getClassificationWeight(classification) {
            if (!classification) return 0;
            const cls = classification.toUpperCase();
            
            // ADMs represent the top tier
            if (cls.includes('ADM')) return 1000;
            
            // Bands represent the management tier (Band 5 = 950, Band 1 = 910, etc.)
            if (cls.includes('BAND')) {
                const match = cls.match(/\d+/);
                const num = match ? parseInt(match[0]) : 0;
                return 900 + (num * 10);
            }
            
            // Operational roles (IS 27, AO 24, FO 18) sorted by their parsed number
            const match = cls.match(/\d+/);
            const num = match ? parseInt(match[0]) : 0;
            return num;
        }

        function mapDataForChart(rawData) {
            const validIds = new Set(rawData.map(row => row['Position ID']).filter(id => id));

            let nodes = rawData.map(row => {
                let parentId = (row['Supervisor Position ID'] || '').trim();
                if (parentId && !validIds.has(parentId)) {
                    parentId = ''; 
                }

                return {
                    id: row['Position ID'],
                    parentId: parentId,
                    name: row['Name'],
                    title: row['Job Title'],
                    branch: row['Branch'],
                    classification: row['Classification'],
                    department: row['Department'],
                    supervisorName: row['Supervisor Name']
                };
            }).filter(node => node.id);

            // Group disconnected roots to avoid crashing
            const rootNodes = nodes.filter(n => !n.parentId);
            if (rootNodes.length > 1) {
                nodes.push({
                    id: 'SYSTEM_ROOT',
                    parentId: '',
                    name: 'Organization Board',
                    title: 'Top Level',
                    branch: 'Executive',
                    classification: 'ADM', // Set dummy root to highest class
                    department: '',
                    supervisorName: ''
                });
                rootNodes.forEach(n => n.parentId = 'SYSTEM_ROOT');
            }

            // SORTING LOGIC: Organizes siblings so ADMs -> Bands -> Operational (by number)
            nodes.sort((a, b) => {
                const weightA = getClassificationWeight(a.classification);
                const weightB = getClassificationWeight(b.classification);
                
                // If weights are equal, sort alphabetically by name
                if (weightA === weightB) {
                    return (a.name || '').localeCompare(b.name || '');
                }
                
                // Sort Descending (highest weights first)
                return weightB - weightA;
            });

            return nodes;
        }

        const branchColors = {
            'Executive': '#0f172a', 
            'Digital Services': '#2563eb', 
            'Corporate Services': '#059669', 
            'Infrastructure & Ops': '#d97706', 
            'Data & Analytics': '#7c3aed', 
            'People & Culture': '#db2777', 
            'Cybersecurity': '#dc2626' 
        };

        function getBranchColor(branchName) {
            return branchColors[branchName] || '#475569';
        }

        let isVertical = true;
        function toggleLayout() {
            isVertical = !isVertical;
            chart.layout(isVertical ? 'top' : 'left').render().fit();
        }

        // Logic to manually open nodes based on Classification (Semantic Depth)
        function expandSemantic(level) {
            chart.collapseAll();
            
            // Expand the root node so the chart isn't invisible
            const rootNode = globalData.find(d => !d.parentId);
            if (rootNode) chart.setExpanded(rootNode.id);

            if (level === 'All') {
                chart.expandAll().render().fit();
                return;
            }

            globalData.forEach(node => {
                const cls = (node.classification || '').toUpperCase();
                
                if (level === 'ADM') {
                    // Level 1: Expand any node that is an ADM
                    if (cls.includes('ADM')) {
                        chart.setExpanded(node.id);
                    }
                } else if (level === 'Band') {
                    // Level 2: Expand any node that is an ADM or a Band
                    if (cls.includes('ADM') || cls.includes('BAND')) {
                        chart.setExpanded(node.id);
                    }
                }
            });
            
            chart.render().fit();
        }

        function renderChart(data) {
            globalData = data;
            document.getElementById('employee-count').textContent = `${data.length} Employees loaded`;
            
            if (chart) {
                chart.data(data).render();
                expandSemantic('ADM'); // Default to expanding Level 1
                return;
            }

            chart = new d3.OrgChart()
                .container('#chart-container')
                .data(data)
                .nodeWidth(d => 260)
                .nodeHeight(d => 120)
                .childrenMargin(d => 50)
                .compactMarginBetween(d => 30)
                .compactMarginPair(d => 60)
                .linkUpdate(function (d, i, arr) {
                    d3.select(this)
                        .attr("stroke", d => {
                            if (d.data._highlightedTeam && d.parent && d.parent.data._highlightedTeam) {
                                return getBranchColor(d.data.branch);
                            }
                            return "#cbd5e1"; 
                        })
                        .attr("stroke-width", d => {
                            if (d.data._highlightedTeam && d.parent && d.parent.data._highlightedTeam) return 4;
                            return 1.5;
                        });
                })
                .nodeContent(function(d, i, arr, state) {
                    const color = getBranchColor(d.data.branch);
                    const initials = d.data.name ? d.data.name.split(' ').map(n => n[0]).join('').substring(0,2) : '--';
                    
                    const isHighlighted = d.data._highlightedTeam;
                    const cardStyle = isHighlighted 
                        ? `border: 2px solid ${color}; box-shadow: 0 0 20px ${color}60; transform: scale(1.02); background-color: #f8fafc;` 
                        : `border: 1px solid #e2e8f0; background-color: white;`;
                    
                    return `
                    <div class="node-card" style="font-family: ui-sans-serif, system-ui, sans-serif; ${cardStyle} border-radius: 12px; width: ${d.width}px; height: ${d.height}px; display: flex; flex-direction: column; overflow: hidden; cursor: pointer; position: relative;">
                        <div style="height: 6px; width: 100%; background-color: ${color};"></div>
                        
                        <div style="padding: 16px; display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div style="width: 48px; height: 48px; border-radius: 9999px; background-color: #f1f5f9; display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${color}; font-size: 16px; border: 1px solid #e2e8f0; flex-shrink: 0;">
                                ${initials}
                            </div>
                            
                            <div style="overflow: hidden;">
                                <div style="font-weight: 700; font-size: 15px; color: #0f172a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${d.data.name}
                                </div>
                                <div style="font-size: 12px; color: #475569; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${d.data.title}
                                </div>
                                <div style="font-size: 11px; font-weight: 600; color: ${color}; margin-top: 6px; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${d.data.branch}
                                </div>
                            </div>
                        </div>

                        ${d.data._directSubordinates > 0 ? `
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 24px; background-color: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #64748b; font-weight: 500;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5"></path>
                                <path d="M9 21l-4-4 4-4"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            ${d.data._directSubordinates} Reports
                        </div>
                        ` : ''}
                    </div>
                    `;
                })
                .onNodeClick(d => {
                    showProfile(d.data);
                    chart.setCentered(d.data.id).render();
                })
                .render();

            // Default behavior: Open ADMs immediately after drawing
            expandSemantic('ADM');
        }

        Papa.parse(defaultCSV, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                renderChart(mapDataForChart(results.data));
            }
        });

        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('file-status');
            statusEl.textContent = 'Parsing...';
            statusEl.classList.remove('hidden');

            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    try {
                        const mapped = mapDataForChart(results.data);
                        renderChart(mapped);
                        statusEl.textContent = `Loaded ${mapped.length} employees successfully!`;
                        statusEl.classList.remove('text-red-600');
                        statusEl.classList.add('text-green-600');
                        setTimeout(() => statusEl.classList.add('hidden'), 3000);
                    } catch (err) {
                        statusEl.textContent = 'Error: ' + err.message;
                        statusEl.classList.add('text-red-600');
                    }
                }
            });
            e.target.value = '';
        });

        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                chart.clearHighlighting();
                globalData.forEach(d => d._highlightedTeam = false);
                chart.render();
                return;
            }

            const branches = [...new Set(globalData.map(d => d.branch))].filter(b => b && b.toLowerCase().includes(query));
            const departments = [...new Set(globalData.map(d => d.department))].filter(dp => dp && dp.toLowerCase().includes(query));
            const people = globalData.filter(d => 
                (d.name && d.name.toLowerCase().includes(query)) || 
                (d.title && d.title.toLowerCase().includes(query))
            ).slice(0, 8);

            searchResults.innerHTML = '';
            let hasResults = false;

            branches.forEach(branch => {
                hasResults = true;
                const div = document.createElement('div');
                div.className = 'p-3 border-b border-slate-100 hover:bg-blue-50 cursor-pointer flex items-center gap-3';
                div.innerHTML = `<div class="p-2 bg-blue-100 text-blue-600 rounded-lg shrink-0"><i data-lucide="users" class="w-4 h-4"></i></div>
                    <div class="flex flex-col"><span class="text-sm font-bold text-slate-800">${branch}</span><span class="text-xs text-slate-500">Entire Team / Branch</span></div>`;
                div.onclick = () => highlightTeam('branch', branch);
                searchResults.appendChild(div);
            });

            departments.forEach(dept => {
                hasResults = true;
                const div = document.createElement('div');
                div.className = 'p-3 border-b border-slate-100 hover:bg-emerald-50 cursor-pointer flex items-center gap-3';
                div.innerHTML = `<div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg shrink-0"><i data-lucide="building" class="w-4 h-4"></i></div>
                    <div class="flex flex-col"><span class="text-sm font-bold text-slate-800">Dept: ${dept}</span><span class="text-xs text-slate-500">Entire Department</span></div>`;
                div.onclick = () => highlightTeam('department', dept);
                searchResults.appendChild(div);
            });

            if (people.length > 0) {
                people.forEach(r => {
                    hasResults = true;
                    const div = document.createElement('div');
                    div.className = 'p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer flex items-center gap-3';
                    div.innerHTML = `<div class="p-2 bg-slate-100 text-slate-600 rounded-lg shrink-0"><i data-lucide="user" class="w-4 h-4"></i></div>
                        <div class="flex flex-col"><span class="text-sm font-bold text-slate-800">${r.name}</span><span class="text-xs text-slate-500">${r.title} â€¢ ${r.branch}</span></div>`;
                    div.onclick = () => {
                        searchResults.classList.add('hidden');
                        searchInput.value = r.name;
                        globalData.forEach(d => d._highlightedTeam = false);
                        chart.clearHighlighting();
                        chart.setUpToTheRootHighlighted(r.id);
                        chart.setCentered(r.id);
                        chart.render();
                        showProfile(r);
                    };
                    searchResults.appendChild(div);
                });
            }

            if (hasResults) {
                searchResults.classList.remove('hidden');
                lucide.createIcons();
            } else {
                searchResults.innerHTML = '<div class="p-4 text-sm text-slate-500 text-center">No results found</div>';
                searchResults.classList.remove('hidden');
            }
        });

        function highlightTeam(type, value) {
            searchResults.classList.add('hidden');
            searchInput.value = value;
            chart.clearHighlighting();

            const teamNodes = globalData.filter(d => d[type] === value);
            const teamIds = new Set(teamNodes.map(d => d.id));
            const teamLeaders = teamNodes.filter(d => !teamIds.has(d.parentId));
            const mainLeader = teamLeaders.length > 0 ? teamLeaders[0] : null;

            globalData.forEach(d => { d._highlightedTeam = (d[type] === value); });

            chart.collapseAll();

            if (mainLeader) {
                let currentId = mainLeader.parentId;
                while (currentId) {
                    chart.setExpanded(currentId);
                    const parentNode = globalData.find(d => d.id === currentId);
                    currentId = parentNode ? parentNode.parentId : null;
                }
            }

            teamNodes.forEach(node => { chart.setExpanded(node.id); });

            chart.render();
            setTimeout(() => { chart.fit(); }, 300);
            closeProfile();
        }

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        const profilePanel = document.getElementById('profilePanel');
        
        function showProfile(data) {
            const initials = data.name ? data.name.split(' ').map(n => n[0]).join('').substring(0,2) : '--';
            document.getElementById('profileAvatar').textContent = initials;
            document.getElementById('profileAvatar').style.color = getBranchColor(data.branch);
            document.getElementById('profileName').textContent = data.name || 'Unknown';
            document.getElementById('profileTitle').textContent = data.title || 'Unknown Position';
            document.getElementById('profileBranch').textContent = data.branch || 'No Branch';
            document.getElementById('profilePosId').textContent = data.id || 'N/A';
            document.getElementById('profileDept').textContent = data.department || 'N/A';
            document.getElementById('profileClass').textContent = data.classification || 'N/A';
            document.getElementById('profileSupervisor').textContent = data.supervisorName || 'Root / None';

            profilePanel.classList.remove('translate-x-[120%]', 'opacity-0');
            profilePanel.classList.add('translate-x-0', 'opacity-100');
        }

        function closeProfile() {
            profilePanel.classList.remove('translate-x-0', 'opacity-100');
            profilePanel.classList.add('translate-x-[120%]', 'opacity-0');
        }
    </script>
</body>
</html>
